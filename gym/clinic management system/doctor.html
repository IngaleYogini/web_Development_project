<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/doctor-style.css">
    <link rel="stylesheet" href="css/staff.css">
    <link rel="stylesheet" href="css/patient_list.css">
    <link rel="stylesheet" href="css/setting.css">
    <title>Doctor</title>
    <style>
        .logo {
            display: block;
        }
    </style>
</head>

<body>
    <div class="logo">
        <svg viewBox="0 0 300 150" class="curved-text">
            <defs>
                <path id="curve" d="M 50,150 A 100,100 0 0,1 250,150" />
            </defs>
            <text>
                <textPath href="#curve" startOffset="50%" text-anchor="middle">
                    Morya Dental Clinic
                </textPath>
            </text>
        </svg>
        <div class="circular-image">
            <img src="./img/mdc.jpg" alt="Clinic Logo" />
        </div>
    </div>

    <div class="sidebar">
        <h2>Clinic Management System</h2>
        <ul>
            <li><a href="#">Dashboard</a></li>
            <li><a href="#ext_doc">External Doctors</a></li>
            <li><a href="#staffForm">Staff</a></li>
            <li><a href="#pati_list">Appointments</a></li>
            <li><a href="setting-sec.php">Settings</a></li>
        </ul>
    </div>

    <div class="main-content">
        <div class="header">
            <h1>Dashboard</h1>
            <div class="user-info">
                <img src="./img/admin.jpg" alt="User">
                <span>Admin</span>
            </div>
        </div>

        <div class="dashboard-cards">
            <div class="card">
                <i class="fas fa-user-md"></i>
                <h3 class="external-doctors-count">Loading...</h3>
                <p>External Doctors</p>
            </div>
            <div class="card">
                <i class="fas fa-calendar-check"></i>
                <h3 class="appointments-count">Loading...</h3>
                <p>Appointments</p>
            </div>
            <div class="card">
                <i class="fas fa-calendar-check"></i>
                <h3 class="attended-count">Loading...</h3>
                <p>Attended</p>
            </div>
            <div class="card">
                <i class="fas fa-calendar-check"></i>
                <h3 class="remaining-count">Loading...</h3>
                <p>Remaining</p>
            </div>
        </div>
        <div id="pati_list">
            <h2>Appointments</h2>
            <ul id="patientList">Loading...</ul>
        </div>
        <div id="ext_doc" class="external-doctors">
            <h2>Manage External Doctors</h2>
            <form id="doctorForm">
                <input type="text" id="doctor_name" placeholder="Doctor Name" required />
                <input type="text" id="contact_number" placeholder="Contact Number" required />
                <input type="text" id="clinic_name" placeholder="Clinic Name" required />
                <button type="submit">Add Doctor</button>
            </form>
            <div id="doctor_list">
                <h2>Doctors List</h2>
                <ul id="doctorsList">Loading...</ul>
            </div>
        </div>       
         <div class="external-doctors">
            <h2>Manage Staff</h2>
            <form id="staffForm">
                <input type="text" name="staff_name" placeholder="Staff Name" required />
                <input type="text" name="position" placeholder="Position" required />
                <input type="text" name="contact_number" placeholder="Contact Number" required />
                <button type="submit">Add Staff</button>
            </form>
            <h2>Staff List</h2>
            <ul id="staffList">Loading...</ul>
        </div>
       
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
        import { getDatabase, ref, set, remove, update, onValue } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";


        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBg5AXmG8VwxpFonWdefuj0CAw-Dgxyft4",
            authDomain: "adddoc-cd904.firebaseapp.com",
            projectId: "adddoc-cd904",
            storageBucket: "adddoc-cd904.firebasestorage.app",
            messagingSenderId: "880570605246",
            appId: "1:880570605246:web:45ba3d8b12ff0d939f88ef"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Function to Add Doctor
         document.getElementById("doctorForm").addEventListener("submit", async function (e) {
            e.preventDefault();
            const doctorName = document.getElementById("doctor_name").value.trim();
            const contactNumber = document.getElementById("contact_number").value.trim();
            const clinicName = document.getElementById("clinic_name").value.trim();

            if (doctorName && contactNumber && clinicName) {
                try {
                    await set(ref(db, "extDoc/" + doctorName), {
                        doctor_name: doctorName,
                        contact_number: contactNumber,
                        clinic_name: clinicName
                    });
                    alert("Doctor added successfully!");
                    e.target.reset();
                    fetchDoctors();
                } catch (error) {
                    alert("Error adding doctor.");
                }
            }
        });

        document.getElementById("doctorForm").addEventListener("submit", async function (e) {
            e.preventDefault();
            const doctorName = document.getElementById("doctor_name").value.trim();
            const contactNumber = document.getElementById("contact_number").value.trim();
            const clinicName = document.getElementById("clinic_name").value.trim();

            if (doctorName && contactNumber && clinicName) {
                try {
                    await set(ref(db, "extDoc/" + doctorName), {
                        doctor_name: doctorName,
                        contact_number: contactNumber,
                        clinic_name: clinicName
                    });
                    alert("Doctor added successfully!");
                    e.target.reset();
                    fetchDoctors();
                } catch (error) {
                    alert("Error adding doctor.");
                }
            }
        });

        function fetchDoctors() {
            const doctorsList = document.getElementById("doctorsList");
            const externalDoctorsCount = document.querySelector(".external-doctors-count");

            doctorsList.innerHTML = "Loading...";
            externalDoctorsCount.innerText = "Loading...";

            const doctorsRef = ref(db, "extDoc/");
            onValue(doctorsRef, (snapshot) => {
                doctorsList.innerHTML = "";
                let count = 0;

                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        count++;
                        const doctor = childSnapshot.val();
                        const doctorKey = childSnapshot.key;

                        const li = document.createElement("li");
                        li.innerHTML = `
                            <strong>${doctor.doctor_name}</strong> - ${doctor.contact_number} (${doctor.clinic_name}) 
                            <button class="delete-btn" data-id="${doctorKey}">Remove</button>
                        `;

                        doctorsList.appendChild(li);
                    });

                    document.querySelectorAll(".delete-btn").forEach((btn) => {
                        btn.addEventListener("click", function () {
                            removeDoctor(this.getAttribute("data-id"));
                        });
                    });
                } else {
                    doctorsList.innerHTML = "<li>No doctors added yet.</li>";
                }

                externalDoctorsCount.innerText = count;
            });
        }

        function removeDoctor(doctorId) {
            if (confirm("Are you sure you want to remove this doctor?")) {
                remove(ref(db, "extDoc/" + doctorId))
                    .then(() => {
                        alert("Doctor removed successfully!");
                        fetchDoctors();
                    })
                    .catch((error) => {
                        alert("Error removing doctor: " + error.message);
                    });
            }
        }

        fetchDoctors();

        // Function to Add Staff
        document.getElementById("staffForm").addEventListener("submit", async function (e) {
            e.preventDefault();
            const staffName = document.querySelector("input[name='staff_name']").value.trim();
            const position = document.querySelector("input[name='position']").value.trim();
            const contactNumber = document.querySelector("input[name='contact_number']").value.trim();

            if (staffName && position && contactNumber) {
                try {
                    await set(ref(db, "staff/" + staffName), {
                        staff_name: staffName,
                        position: position,
                        contact_number: contactNumber
                    });
                    alert("Staff added successfully!");
                    e.target.reset();
                } catch (error) {
                    alert("Error adding staff.");
                }
            }
        });

        // Function to Fetch and Display Doctors
        // Function to Fetch and Display Doctors
       


        // Function to Fetch and Display Staff
        function fetchStaff() {
            const staffList = document.getElementById("staffList");
            staffList.innerHTML = ""; 

            const staffRef = ref(db, "staff/");
            onValue(staffRef, (snapshot) => {
                staffList.innerHTML = "";
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const staff = childSnapshot.val();
                        const li = document.createElement("li");
                        li.innerHTML = `<strong>${staff.staff_name}</strong> - ${staff.position} (${staff.contact_number})`;
                        staffList.appendChild(li);
                    });
                } else {
                    staffList.innerHTML = "<li>No staff added yet.</li>";
                }
            });
        }
        // Function to Remove Doctor from Firebase
        
       //patient list
       function loadPatients() {
            const patientList = document.getElementById('patientList');
            patientList.innerHTML = "Loading...";

            onValue(ref(db, "patients"), (snapshot) => {
                patientList.innerHTML = "";
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        let patient = childSnapshot.val();
                        let patientId = childSnapshot.key;
                        let li = document.createElement('li');

                        li.innerHTML = `
                            <strong>${patient.name}</strong> - ${patient.phone} (${patient.city})
                            <button class="attend-btn" id="attend-${patientId}" ${patient.attended ? 'disabled' : ''}>
                                ${patient.attended ? 'Attended' : 'Mark Attended'}
                            </button>
                            <button class="remove-btn" onclick="deletePatient('${patientId}')">Remove</button>
                        `;

                        patientList.appendChild(li);

                        // Attach event listener dynamically
                        document.getElementById(`attend-${patientId}`).addEventListener("click", function () {
                            markAttended(patientId, this);
                        });
                    });

                    updateCounts();
                } else {
                    patientList.innerHTML = "<li>No patients added yet.</li>";
                }
            });
        }

        // Function to Mark Patient as Attended
        window.markAttended = function (id, button) {
            console.log("Marking attended for patient ID:", id); // Debugging log

            update(ref(db, "patients/" + id), { attended: true })
                .then(() => {
                    alert("Patient marked as attended!");
                    button.innerText = "Attended";
                    button.style.backgroundColor = "green";
                    button.style.color = "white";
                    button.disabled = true;
                    loadPatients(); // Refresh UI
                })
                .catch((error) => {
                    alert("Error updating patient: " + error.message);
                });
        };

        // Function to Delete Patient
        window.deletePatient = function (id) {
            remove(ref(db, "patients/" + id))
                .then(() => {
                    alert("Patient removed!");
                    loadPatients(); // Refresh UI
                })
                .catch((error) => {
                    alert("Error removing patient: " + error.message);
                });
        };

        // Function to Update Counts
        function updateCounts() {
            const attendedCount = document.querySelector(".attended-count");
            const remainingCount = document.querySelector(".remaining-count");
            const appointmentsCount = document.querySelector(".appointments-count");

            onValue(ref(db, "patients"), (snapshot) => {
                let total = 0, attended = 0;

                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        let patient = childSnapshot.val();
                        total++;
                        if (patient.attended) attended++;
                    });
                }

                appointmentsCount.innerText = total;
                attendedCount.innerText = attended;
                remainingCount.innerText = total - attended;
            });
        }
        loadPatients();
        fetchDoctors();
        fetchStaff();
        loadPatients();
    </script>
</body>

</html>
