<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="css/patient_list.css">
    <link rel="stylesheet" href="css/doctor-style.css">
    <link rel="stylesheet" href="css/staff.css">
    <link rel="stylesheet" href="css/style.css">
    <title>RES</title>
    <style>
        .logo {
            display: block;
        }
  .entry-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-left: 8px;
    border-bottom: 1px solid #ccc;
  }
  #staffList li {
    background-color: #f9f9f9;
   padding-left: 10px;
   padding-bottom: 10px;
   padding-top: 5px;
    margin: 5px 0;
    border-radius: 5px;
    border: 2px solid rgb(1, 1, 96);
    font-size: 16px;
}
#doctor_list li{
    margin-bottom: 5px;
    background-color: #f9f9f9;
    padding-left: 10px;
    padding-bottom: 10px;
    padding-top: 5px;
    border-radius: 5px;
    margin-left: -40px;
    border: 2px solid rgb(1, 1, 96);
    font-size: 16px;
}
  .entry-name {
    font-weight: bold;
    flex-grow: 1;
  }

  .btn-group {
    display: flex;
    gap: 5px;
  }

  .attend-btn, .remove-btn, .delete-btn, .whatsapp-btn {
    padding: 5px 10px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }

    </style>

</head>

<body>
    <div class="logo">
        <svg viewBox="0 0 300 150" class="curved-text">
            <defs>
                <path id="curve" d="M 50,150 A 100,100 0 0,1 250,150" />
            </defs>
            <text>
                <textPath href="#curve" startOffset="50%" text-anchor="middle">
                    Morya Dental Clinic
                </textPath>
            </text>
        </svg>
        <div class="circular-image">
            <img src="./img/mdc.jpg" alt="Clinic Logo" />
        </div>
    </div>

    <div class="sidebar">
        <h2>Clinic Management System</h2>
        <ul>
            <li><a href="#"> Dashboard</a></li>
            <li><a href="#patientList"> Appointments</a></li>
            <li><a href="setting.html"> Settings</a></li>
        </ul>
    </div>

    <div class="main-content">
        <div class="header">
            <h1>Dashboard</h1>
            <div class="user-info">
                <img src="./img/admin.jpg" alt="User">
                <span>Admin</span>
            </div>
        </div>

        <div class="dashboard-cards">
            <div class="card">
                <i class="fas fa-user-md"></i>
                <h3 class="external-doctors-count">Loading...</h3>
                <p>External Doctors</p>
            </div>
            <div class="card">
                <i class="fas fa-calendar-check"></i>
                <h3 class="appointments-count">Loading...</h3>
                <p>Appointments</p>
            </div>
            <div class="card">
                <i class="fas fa-calendar-check"></i>
                <h3 class="attended-count">Loading...</h3>
                <p>Attended</p>
            </div>
            <div class="card">
                <i class="fas fa-calendar-check"></i>
                <h3 class="remaining-count">Loading...</h3>
                <p>Remaining</p>
            </div>
        </div>

        <div class="form-container">
            <h2>Add Patients</h2>
            <form id="patientForm">
                <input type="text" id="patientName" placeholder="Enter Patient Name" required>
                <input type="text" id="phnumber" placeholder="Phone Number" required>
                <input type="text" id="city" placeholder="City" required>
                <button type="submit" id="addPatient">Add Patient</button>
            </form>

            <div class="patient-list">
                <h2>Patient List</h2>
                <ul id="patientList">
                    <!-- Patients will be listed here -->
                </ul>
            </div>
        </div>
         <!-- External Doctors -->
      <div id="ext_doc" class="external-doctors">
        <div id="doctor_list">
          <h2>Doctors List</h2>
          <ul id="doctorsList">Loading...</ul>
        </div>
      </div>
         <!-- Staff -->
      <div class="external-doctors">
        <h2>Staff List</h2>
        <ul id="staffList">Loading...</ul>
      </div>
    </div>
  </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
import { getDatabase, ref, push, set, onValue, remove } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";

// Firebase Configuration
const firebaseConfig = {
    apiKey: "AIzaSyBg5AXmG8VwxpFonWdefuj0CAw-Dgxyft4",
    authDomain: "adddoc-cd904.firebaseapp.com",
    databaseURL: "https://adddoc-cd904-default-rtdb.firebaseio.com",
    projectId: "adddoc-cd904",
    storageBucket: "adddoc-cd904.appspot.com",
    messagingSenderId: "880570605246",
    appId: "1:880570605246:web:b5dc1b1489bf68c29f88ef"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Add Patient to Realtime Database
document.getElementById('patientForm').addEventListener('submit', function (event) {
    event.preventDefault();
    
    let name = document.getElementById('patientName').value;
    let phone = document.getElementById('phnumber').value;
    let city = document.getElementById('city').value;

    const patientsRef = ref(db, "patients");
    const newPatientRef = push(patientsRef); // Generate a unique ID for each patient

    set(newPatientRef, {
        name: name,
        phone: phone,
        city: city
    }).then(() => {
        alert("Patient added successfully!");
        document.getElementById('patientForm').reset();
    }).catch(error => {
        console.error("Error adding patient: ", error);
    });
});
//doctor count

// Load Patients from Realtime Database
function loadPatients() {
  const patientList = document.getElementById('patientList');
  patientList.innerHTML = "Loading...";
  onValue(ref(db, "patients"), (snapshot) => {
    patientList.innerHTML = "";
    if (snapshot.exists()) {
      snapshot.forEach((childSnapshot) => {
        let patient = childSnapshot.val();
        let patientId = childSnapshot.key;

        let li = document.createElement('li');
        li.className = "entry-row";
        li.innerHTML = `
          <div class="entry-name">${patient.name} - ${patient.phone} (${patient.city})</div>
          <div class="btn-group">
            <button class="attend-btn" id="attend-${patientId}" ${patient.attended ? 'disabled' : ''}>
              ${patient.attended ? 'Attended' : 'Mark Attended'}
            </button>
            <button class="remove-btn" onclick="deletePatient('${patientId}')">Remove</button>
            <button class="whatsapp-btn" onclick="sendWhatsApp('${patient.phone}', '${patient.name}')">Send Message</button>
          </div>
        `;
        patientList.appendChild(li);
        document.getElementById(`attend-${patientId}`).addEventListener("click", function () {
          markAttended(patientId, this);
        });
      });
      updateCounts();
    } else {
      patientList.innerHTML = "<li>No patients added yet.</li>";
    }
  });
}

window.sendWhatsApp = function (phone, name) {
  const sanitizedPhone = phone.replace(/\D/g, '');
  const message = `Hello ${name}, please be in Morya Dental clinic in 30 Minutes for your appointment!`;
  const encodedMessage = encodeURIComponent(message);
  const url = `https://wa.me/${sanitizedPhone}?text=${encodedMessage}`;
  window.open(url, "_blank");
};


        // Function to Mark Patient as Attended
        window.markAttended = function (id, button) {
            console.log("Marking attended for patient ID:", id); // Debugging log

            update(ref(db, "patients/" + id), { attended: true })
                .then(() => {
                    alert("Patient marked as attended!");
                    button.innerText = "Attended";
                    button.style.backgroundColor = "green";
                    button.style.color = "white";
                    button.disabled = true;
                    loadPatients(); // Refresh UI
                })
                .catch((error) => {
                    alert("Error updating patient: " + error.message);
                });
        };

// Delete a Patient
window.deletePatient = function (id) {
    const patientRef = ref(db, "patients/" + id);
    remove(patientRef).then(() => {
        alert("Patient removed!");
    }).catch(error => {
        console.error("Error deleting patient:", error);
    });
}

// Load patients on page load
window.onload = loadPatients;
// Function to Update Counts
function updateCounts() {
            const attendedCount = document.querySelector(".attended-count");
            const remainingCount = document.querySelector(".remaining-count");
            const appointmentsCount = document.querySelector(".appointments-count");

            onValue(ref(db, "patients"), (snapshot) => {
                let total = 0, attended = 0;

                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        let patient = childSnapshot.val();
                        total++;
                        if (patient.attended) attended++;
                    });
                }

                appointmentsCount.innerText = total;
                attendedCount.innerText = attended;
                remainingCount.innerText = total - attended;
            });
        }
        //ExtDoc
        function fetchExternalDoctorsCount() {
    const externalDoctorsCount = document.querySelector(".external-doctors-count");

    onValue(ref(db, "extDoc/"), (snapshot) => {
        let count = snapshot.exists() ? snapshot.size : 0;
        externalDoctorsCount.innerText = count;
    });
}

// Call function on page load
fetchExternalDoctorsCount();
  // Function to Fetch and Display Staff
  function fetchStaff() {
    const staffList = document.getElementById("staffList");
    staffList.innerHTML = "";

    const staffRef = ref(db, "staff/");
    onValue(staffRef, (snapshot) => {
        staffList.innerHTML = "";
        if (snapshot.exists()) {
            snapshot.forEach((childSnapshot) => {
                const staff = childSnapshot.val();
                const staffKey = childSnapshot.key;

                const li = document.createElement("li");
                li.innerHTML = `
                    <strong>${staff.staff_name}</strong> - ${staff.position} (${staff.contact_number})
                    <button class="delete-btn" data-id="${staffKey}">Remove</button>
                `;
                staffList.appendChild(li);
            });

            document.querySelectorAll("#staffList .delete-btn").forEach((btn) => {
                btn.addEventListener("click", function () {
                    removeStaff(this.getAttribute("data-id"));
                });
            });

        } else {
            staffList.innerHTML = "<li>No staff added yet.</li>";
        }
    });
}
function fetchDoctors() {
            const doctorsList = document.getElementById("doctorsList");
            const externalDoctorsCount = document.querySelector(".external-doctors-count");

            doctorsList.innerHTML = "Loading...";
            externalDoctorsCount.innerText = "Loading...";

            const doctorsRef = ref(db, "extDoc/");
            onValue(doctorsRef, (snapshot) => {
                doctorsList.innerHTML = "";
                let count = 0;

                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        count++;
                        const doctor = childSnapshot.val();
                        const doctorKey = childSnapshot.key;

                        const li = document.createElement("li");
                        li.innerHTML = `
                            <strong>${doctor.doctor_name}</strong> - ${doctor.contact_number} (${doctor.clinic_name}) 
                            <button class="delete-btn" data-id="${doctorKey}">Remove</button>
                        `;

                        doctorsList.appendChild(li);
                    });

                    document.querySelectorAll(".delete-btn").forEach((btn) => {
                        btn.addEventListener("click", function () {
                            removeDoctor(this.getAttribute("data-id"));
                        });
                    });
                } else {
                    doctorsList.innerHTML = "<li>No doctors added yet.</li>";
                }

                externalDoctorsCount.innerText = count;
            });
        }
        fetchDoctors();
fetchStaff();
    </script>

</body>

</html>